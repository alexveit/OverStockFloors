<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script type="text/javascript">

function get_string_array(result)
{
	var init = 0;
	var arr = new Array();
	for(var i = 0; i < result.length; i++)
	{		
		if(result[i] == '\n')
		{
			arr.push(result.substring(init,i))
			i++;
			init = i;
		}	
	}
	return arr;
}

function calculateDistances(dest)
{
	var service = new google.maps.DistanceMatrixService();
	service.getDistanceMatrix(
	{
		origins: ['131 merchant square 30040'],
		destinations: dest,
		travelMode: google.maps.TravelMode.DRIVING,
		unitSystem: google.maps.UnitSystem.METRIC,
		avoidHighways: false,
		avoidTolls: false
	}, callback);
}

function MyDistances(dest, mi)
{
	this.dest = dest;
	this.mi = mi;
}

function callback(response, status)
{
	if (status != google.maps.DistanceMatrixStatus.OK)
	{
		alert('Error was: ' + status);
		return;
	}
	
	var origins = response.originAddresses;
	var destinations = response.destinationAddresses;
	
	var dists = new Array();
	
	for (var i = 0; i < origins.length; i++)
	{
		var results = response.rows[i].elements;
		for (var j = 0; j < results.length; j++)
		{
			var dist = parseFloat(results[j].distance.text)/1.60934;
			dists.push(new MyDistances(destinations[j],dist));	
		}
	}
	
	dists.sort(function(a,b) { return a.mi - b.mi; } );
	
	for (var i = 0; i < dists.length; i++)
	{
		var newNode = document.createElement("li");
		var newContent = document.createTextNode(i.toString() + " " + dists[i].dest + ' ---- ' + dists[i].mi.toFixed(1) + " mi");
		var my_ul = document.getElementById("here");
		newNode.appendChild(newContent);
		document.body.insertBefore(newNode, my_ul);
	}
}

function FileReaderOnLoad(e)
{
	var arr = get_string_array(e.target.result);
	
	var iter = 0;
	
	while(true)
	{
		var buff = arr.slice(0,25);
		calculateDistances(buff);
		arr.splice(0,25);
		
		/*iter++;
		
		if(iter == 5)
			break;*/
		

		
		if(arr.length < 1)
			break;
	}
}

function readSingleFile(evt)
{
	var file = evt.target.files[0]; 

	if(!file)
	{
		alert("Failed to load file");
		return;
	}
	
	var reader = new FileReader();
	reader.onload = FileReaderOnLoad;
	reader.readAsText(file);
}

function dothing()
{
	document.getElementById('fileinput').addEventListener('change', readSingleFile, false);
}

</script>

<body onload="dothing()">

<input type="file" id="fileinput" />

<div id="here">
</div>

</body>
