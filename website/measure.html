<!DOCTYPE html>
<html>
<head>
<script>

var mymeasurements = new Array();

function do_something()
{
	var i = 5/7;
	
	return i;
}

function Measurement(input)
{
	if (typeof(input)==='string')
	{
		var n;
		if(input.indexOf("x") !== -1)
			n = input.split("x");
		else if(input.indexOf("/") !== -1)
			n = input.split("/");
		else if(input.indexOf("+") !== -1)
			n = input.split("+");
		else if(input.indexOf(":") !== -1)
			n = input.split(":");

		this.width = parseFloat(n[0], 10);
		this.length = parseFloat(n[1], 10);
	}
	else
	{
		this.width = input.width;
		this.length = input.length;
	}
}

Measurement.prototype.add_width = function(width) { this.width += width; }

Measurement.prototype.toString = function() { return this.width.toString() + "x" + this.length.toString(); }

function isWhitespaceNotEmpty(text) { return text.length > 0 && !/[^\s]/.test(text); }

var standard;
var needs;

function add_table(max)
{
	var size = 0;
	if(standard.length > needs.length)
		size = standard.length;
	else
		size = needs.length;

	var html = "<table border=\"1\" style=\"width:210px;\"><tbody><tr>";
	html = html.concat("<td style=\"width:50%; text-align:center;\">Standard</td>");
	html = html.concat("<td style=\"width:50%; text-align:center;\">Needs</td></tr>");

	var td = "<td style=\"text-align:center;\">";

	for(var i = 0; i < size; i++)
	{
		html = html.concat("<tr>");

		if(i < standard.length)
			html = html.concat(td + standard[i].toString() + "</td>");
		else
			html = html.concat("<td>&nbsp;</td>");

		if(i < needs.length)
			html = html.concat(td + needs[i].toString() + "</td>");
		else
			html = html.concat("<td>&nbsp;</td>");

		html = html.concat("</tr>");
	}

	var len = 0;
	for(var i = 0; i < standard.length; i++)
	{
		len += standard[i].length;
	}

	if(len > 0 || max > 0)
	{
		html = html.concat("<tr style=\"background-color:yellow;\">");
	
		if(len > 0)
		{
			html = html.concat("<td style=\"text-align:center;\">12x" + len + "</td>");
			
		}
		else
		{
			html = html.concat("<td></td>");
		}
		
		if(max > 0)
		{
			html = html.concat("<td style=\"text-align:center;\">12x" + max + "</td></tr>");
		}
		else
		{
			html = html.concat("<td></td></tr>");
		}
		
		var total = max + len;
		
		html = html.concat("<tr style=\"background-color:magenta;\"><td colspan=\"2\" style=\"text-align:center;\">12x" + total + "</td></tr>");
		
		html = html.concat("</tbody></table>");
		document.getElementById("addtable").innerHTML = html;
	}
}

function split_standard_from_needs()
{
	for (var i = 0; i < mymeasurements.length; i++)
	{
		var temp_w = mymeasurements[i].width;

		if(temp_w < 12.0)
		{
			needs.push(new Measurement(mymeasurements[i]));
		}
		else if(temp_w >= 12.0 && temp_w < 13.0)
		{
			standard.push(new Measurement(mymeasurements[i]));
		}
		else
		{
			var good = false;
			while(!good)
			{

				if(temp_w >= 12.0 && temp_w < 13.0)
				{
					standard.push(new Measurement("12x" + mymeasurements[i].length.toString()));
					good = true;
				}
				else if(temp_w > 12.0)
				{
					standard.push(new Measurement("12x" + mymeasurements[i].length.toString()));
					temp_w -= 12;
				}
				else
				{
					needs.push(new Measurement(temp_w.toString() + "x" + mymeasurements[i].length.toString()));
					good = true;
				}
			}
		}
	}
}

function aggregate_same_lengths()
{
	for (var i = 0; i < needs.length; i++)
	{
		for (var j = i+1; j < needs.length; j++)
		{
			if(needs[j].length == needs[i].length)
			{
				needs[i].add_width(needs[j].width);
				needs.splice(j, 1);
			}
		}
	}
}

function consolidate_standards()
{
	var round = document.getElementById("round").checked;
	var toround = document.getElementById("toround");
	var round_val = parseFloat(toround[toround.selectedIndex].value);
	for (var i = 0; i < needs.length; i++)
	{
		if(round && needs[i].width >= round_val && needs[i].width < 12.0)
		{
			needs[i].width = 12;
			standard.push(new Measurement(needs[i]));
			needs.splice(i, 1);
		}
		else if(needs[i].width >= 12.0 && needs[i].width < 13.0)
		{
			standard.push(new Measurement(needs[i]));
			needs.splice(i, 1);
		}
		else if(needs[i].width > 12.0)
		{
			var good = false;
			while(!good)
			{
				if(round && needs[i].width >= round_val && needs[i].width < 12.0)
				{
					needs[i].width = 12;
					standard.push(new Measurement(needs[i].width.toString() + "x" + needs[i].length.toString()));
					needs.splice(i, 1);
					good = true;
				}
				else if(needs[i].width >= 12.0 && needs[i].width < 13.0)
				{
					standard.push(new Measurement(needs[i].width.toString() + "x" + needs[i].length.toString()));
					needs.splice(i, 1);
					good = true;
				}
				else if(needs[i].width > 12.0)
				{
					standard.push(new Measurement(needs[i].width.toString() + "x" + needs[i].length.toString()));
					needs[i].width -= 12;
				}
				else
				{
					good = true;
				}
			}
		}
	}
}

function get_ordered_needs()
{
	var ordered_needs = new Array()

	for(var i = 0; i < needs.length; i++)
	{
		ordered_needs.push(new Measurement(needs[i]));
	}

	ordered_needs.sort(function(a,b) { return b.length - a.length; } );
	
	return ordered_needs;
}

function index_class(val, index)
{
	this.val = val;
	this.index = index;
}

function get_index_from_left(grid, level)
{
	var val = grid[0];
	
	var lowest = new Array();
	
	lowest.push(new index_class(val,0));
	
	for(var i = 0; i < grid.length; i++)
	{
		if(grid[i] != val)
		{
			val = grid[i]
			lowest.push(new index_class(val,i));
		}
	}
	
	lowest.sort(function(a,b) { return a.val - b.val; } );
	
	var index = 0;
	
	if(level < lowest.length)
		index = lowest[level].index;
	
	return index;
}

function get_max_index(grid)
{
	var max = grid[0];
	var index = 0;
	
	for(var i = 0; i < grid.length; i++)
	{
		if(grid[i] > max)
		{
			index = i;
			max = grid[i];
		}
	}
	
	return index;
}

function get_max(grid)
{
	var max = grid[0];
	
	for(var i = 0; i < grid.length; i++)
	{
		if(grid[i] > max)
		{
			max = grid[i];
		}
	}
	
	return max;
}

function get_hight_for_canvas()
{
	var val = 0;
	for(var i = 0; i < needs.length; i++)
	{
		val += needs[i].length;
	}
	return val;
}

function calc_totals()
{
	var ordered_needs = get_ordered_needs();
	
	var accounted_for = new Array();
	
	var grid = new Array(0,0,0,0,0,0,0,0,0,0,0,0);

	var good = false;
	
	var level = 0;
	
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext("2d");
	
	var ctx_multiplier = 20;
	
	var hight_for_canvas = get_hight_for_canvas();
	
	canvas.height = (hight_for_canvas*ctx_multiplier);
	
	while(!good)
	{	
		for(var i = 0; i < ordered_needs.length; i++)
		{
			var index_from_left = get_index_from_left(grid,level);
			if(index_from_left == 0)
			{
				level = 0;
				var max_index = get_max_index(grid);
				if(max_index != 0)
				{
					if(ordered_needs[i].width > max_index)
					{
						var max = get_max(grid);
						for(var q = 0; q < max_index; q++)
						{
							grid[q] = max;
						}
					}
				}
			}
			if(ordered_needs[i].width <= (12-index_from_left))
			{
				var len = 0;
				
				accounted_for.push(new Measurement(ordered_needs[i]));
				
				var x = index_from_left*ctx_multiplier;
				var y = grid[index_from_left]*ctx_multiplier;
				var w = ordered_needs[i].width*ctx_multiplier;
				var h = ordered_needs[i].length*ctx_multiplier;
				
				
				for(var j = index_from_left, k = 0; k < ordered_needs[i].width; j++, k++)
				{
					if(k == 0)
					{
						grid[j] += parseInt(ordered_needs[i].length);
						len = grid[j];
					}
					else
					{
						grid[j] = len;
					}
				}
				
				var temp = (12*ctx_multiplier) - x;
				
				ctx.fillStyle="#FF0000";
				ctx.fillRect(x,y,temp,h);
				ctx.fillStyle="#000000";
				ctx.fillRect(x,y,w,h);
				ctx.fillStyle="#0000FF";
				ctx.fillRect(x+1,y+1,w-1,h-1);
	
				ordered_needs.splice(i, 1);
				i--;
			}	
		}
		
		if(ordered_needs.length == 0)
			good = true;
			
		level++;
	}
		
	return get_max(grid);
}

function calc_steps()
{
	var steps = parseFloat(document.forms["myForm"]["steps"].value);
	
	var val = Math.ceil((steps/3.0)*2.0);
	
	while(true)
	{
		if(val%2!=0)
		{
			val++;
		}
		else
		{
			break;
		}
	}
	
	standard.push(new Measurement("12x" + val));
}

function calculate()
{
	standard = new Array();
	needs = new Array();

	split_standard_from_needs();
	aggregate_same_lengths();
	consolidate_standards();
	
	calc_steps();
	
	var max = calc_totals();
	
	add_table(max);

}

function retrieve_measurement()
{
	var val = document.forms["myForm"]["measurement"].value;

	if (val==null || val=="" || isWhitespaceNotEmpty(val))
	{
		calculate();
		document.getElementById("measurement").focus()
		return false;
	}
	
	add_measurement(val)
	return val;
}

function add_measurement(val)
{
	var measure = new Measurement(val);

	mymeasurements.push(measure);

	var newNode = document.createElement("li");
	var newContent = document.createTextNode(measure.toString());
	var my_ul = document.getElementById("mylist");

	newNode.appendChild(newContent);

	document.body.insertBefore(newNode, my_ul);
	document.forms["myForm"]["measurement"].value = "";

	document.getElementById("measurement").focus();

}

function checkEnter(e)
{
	e = e || event;
	var txtArea = /textarea/i.test((e.target || e.srcElement).tagName);
	var is_enter = (e.keyCode || e.which || e.charCode || 0) !== 13;

	if(!is_enter)
		retrieve_measurement();

	return txtArea || is_enter;
}

function load_debub_input()
{
	var data = "12x18+10x12.5+4x6+3x3+12x11.5+2x8+12x14.5+22x16+26x4+3x3+6x2";
	
	var n = data.split("+");
	
	for(var i = 0; i < n.length; i++)
	{
		add_measurement(n[i]);
	}
	
	document.getElementById("round").checked = true;
}

function load()
{
	
	load_debub_input();
	
	document.getElementById("measurement").focus();
}

</script>
</head>
<body onload="load()">

<table border="1">
<tbody>
	<tr>
		<td style="width:210px;">
			Use x / + or : to separate measurements. The maximum precision is by quarters<br />
			<table style="width:100%;">
				<tbody>
					<tr>
						<td style="text-align:center;">1/4 = 0.25</td>
						<td style="text-align:left;">2/4 = 0.5</td>
					</tr>
					<tr>
						<td style="text-align:center;">1/2 = 0.5</td>
						<td style="text-align:left;">3/4 = 0.75</td>
					</tr>
				</tbody>
			</table>
			Valid input examples are:<br />
			<table style="width:100%;">
				<tbody>
					<tr>
						<td style="text-align:center;">15.75x7.5</td>
						<td style="text-align:left;">15+10</td>
					</tr>
					<tr>
						<td style="text-align:center;">10/8.25</td>
						<td style="text-align:left;">13.5:12</td>
					</tr>
				</tbody>
			</table>
		</td>
	</tr>
</tbody>
</table>

<form name="myForm">
<table>
	<tbody>
		<tr>
			<td colspan="2"><input type="checkbox" id="round" value="Bike">Round
				<select id="toround">
					<option value="11">11'</option>
					<option value="10">10'</option>
					<option value="9">9'</option>
					<option value="8">8'</option>
					<option value="7">7'</option>
					<option value="6">6'</option>
					<option value="5">5'</option>
					<option value="4">4'</option>
					<option value="3">3'</option>
					<option value="2">2'</option>
					<option value="1">1'</option>
				</select> to 12'
			</td>
		</tr>
		<tr>
			<td style="text-align:right;"><input id="measurement" type="text" size="13" onkeypress="return checkEnter(event)" /></td>
			<td style="text-align:center;"><input type="button" onclick="retrieve_measurement()" value="    add    "></td>
		</tr>
		<tr>
			<td style="text-align:right;">Step count: <input id="steps" type="text" size="1" /></td>
			<td style="text-align:center;"><input type="button" onclick="calculate()" value="calculate"></td>
		</tr>
	</tbody>
</table>
</form>

<hr style="width:208px; text-align:left; margin-left:0px">
<hr style="width:208px; text-align:left; margin-left:0px" id='mylist'>

<div id="addtable"></div>

<div style="position:absolute; left:300px; top:10px;">
<canvas id="myCanvas" width="240" height="100" <!--style="border:1px solid #000000;"-->>
Your browser does not support the HTML5 canvas tag.
</canvas>
</div>

</body>

</html>

